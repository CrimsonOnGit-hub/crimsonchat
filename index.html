<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photon Chat Bridge</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            background: #1a1a1a; 
            color: #00ff00; 
            margin: 0;
        }
        h1 { color: #00ff00; text-shadow: 0 0 10px #00ff00; }
        .container { max-width: 800px; margin: 0 auto; }
        #debug-log, #chat-log { 
            background: #000; 
            border: 2px solid #00ff00; 
            padding: 15px; 
            height: 250px; 
            overflow-y: auto; 
            margin-bottom: 15px;
            font-size: 12px;
            box-shadow: 0 0 20px rgba(0,255,0,0.3);
        }
        #debug-log div, #chat-log div {
            margin: 2px 0;
            line-height: 1.4;
        }
        .input-group {
            display: flex;
            gap: 10px;
        }
        input { 
            flex: 1;
            padding: 10px; 
            background: #000; 
            color: #00ff00; 
            border: 2px solid #00ff00; 
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        input:focus {
            outline: none;
            box-shadow: 0 0 10px #00ff00;
        }
        button { 
            padding: 10px 20px; 
            background: #00ff00; 
            color: #000; 
            border: none; 
            cursor: pointer;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
        }
        button:hover:not(:disabled) {
            background: #00cc00;
            box-shadow: 0 0 15px #00ff00;
        }
        button:disabled { 
            background: #333; 
            color: #666; 
            cursor: not-allowed; 
        }
        .status {
            text-align: center;
            padding: 10px;
            margin-bottom: 10px;
            border: 2px solid #00ff00;
            background: #000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° Photon VR Chat Bridge ‚ö°</h1>
        
        <div class="status" id="status">üî¥ INITIALIZING...</div>
        
        <h3>üìã Debug Log:</h3>
        <div id="debug-log"></div>
        
        <h3>üí¨ Chat Messages:</h3>
        <div id="chat-log"></div>
        
        <div class="input-group">
            <input type="text" id="msgInput" placeholder="Waiting for connection..." disabled>
            <button id="sendBtn" onclick="sendMsg()" disabled>SEND</button>
        </div>
    </div>

    <!-- Load Photon SDK -->
    <script src="https://photonengine.github.io/photon-javascript/Photon-Javascript_SDK.min.js"></script>
    
    <script>
        // ===== CONFIG =====
        const APP_ID = "512c0979-f7b9-496c-b07b-5d5f753ae9c9";
        const VERSION = "1.0";
        const CHANNEL = "ingame";
        
        var client = null;
        var isConnected = false;

        // ===== HELPERS =====
        function dbg(msg) {
            const box = document.getElementById("debug-log");
            const time = new Date().toLocaleTimeString();
            box.innerHTML += `<div>[${time}] ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
            console.log(`[${time}] ${msg}`);
        }

        function chat(sender, msg) {
            const box = document.getElementById("chat-log");
            box.innerHTML += `<div><b>${sender}:</b> ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        function setStatus(text, color) {
            const status = document.getElementById("status");
            status.textContent = text;
            status.style.borderColor = color;
            status.style.color = color;
        }

        function enableInput(enabled) {
            document.getElementById("msgInput").disabled = !enabled;
            document.getElementById("sendBtn").disabled = !enabled;
            document.getElementById("msgInput").placeholder = enabled ? "Type your message..." : "Not connected";
        }

        // ===== MAIN INIT =====
        window.addEventListener('load', function() {
            dbg("üöÄ GitHub Pages loaded");
            dbg("üåê Protocol: " + window.location.protocol);
            dbg("üìç URL: " + window.location.href);
            
            // Wait for Photon SDK
            let attempts = 0;
            const waitForSDK = setInterval(function() {
                attempts++;
                
                if (typeof Photon !== 'undefined') {
                    clearInterval(waitForSDK);
                    dbg("‚úÖ Photon SDK loaded successfully!");
                    dbg("üì¶ SDK Version: " + (Photon.version || "Unknown"));
                    startPhoton();
                } else if (attempts >= 30) {
                    clearInterval(waitForSDK);
                    dbg("‚ùå FATAL: Photon SDK failed to load after 15 seconds");
                    dbg("üîß Try: Refresh the page or check browser console (F12)");
                    setStatus("üî¥ SDK LOAD FAILED", "#ff0000");
                    chat("SYSTEM", "Failed to load Photon SDK. Check your internet connection.");
                } else {
                    if (attempts % 5 === 0) {
                        dbg("‚è≥ Waiting for SDK... (" + attempts + "/30)");
                    }
                }
            }, 500);
        });

        function startPhoton() {
            try {
                dbg("üîß Creating Photon.Chat.ChatClient...");
                
                // Verify Chat exists
                if (!Photon.Chat || !Photon.Chat.ChatClient) {
                    throw new Error("Photon.Chat.ChatClient is not available in SDK");
                }

                client = new Photon.Chat.ChatClient(
                    Photon.ConnectionProtocol.Wss,
                    APP_ID,
                    VERSION
                );

                dbg("‚úÖ Client created");
                dbg("üéØ App ID: " + APP_ID.substring(0, 8) + "...");

                // Event: State Change
                client.onStateChange = function(state) {
                    dbg("üì° State changed to: " + state);
                    
                    // State 2 = ConnectedToFrontEnd
                    if (state === 2) {
                        dbg("üéâ CONNECTED TO PHOTON!");
                        setStatus("üü¢ CONNECTED", "#00ff00");
                        dbg("üì¢ Subscribing to channel: " + CHANNEL);
                        client.subscribe([CHANNEL]);
                        isConnected = true;
                        enableInput(true);
                        chat("SYSTEM", "‚úÖ Connected to " + CHANNEL);
                    } 
                    // State 0 = Disconnected
                    else if (state === 0) {
                        dbg("‚ö†Ô∏è DISCONNECTED");
                        setStatus("üî¥ DISCONNECTED", "#ff0000");
                        isConnected = false;
                        enableInput(false);
                        chat("SYSTEM", "‚ùå Disconnected from Photon");
                    }
                    // State 1 = Connecting
                    else if (state === 1) {
                        dbg("üîÑ Connecting...");
                        setStatus("üü° CONNECTING...", "#ffff00");
                    }
                };

                // Event: Messages
                client.onChatMessages = function(channelName, messages) {
                    dbg("üì• Received " + messages.length + " message(s) on " + channelName);
                    
                    for (let i = 0; i < messages.length; i++) {
                        const msg = messages[i];
                        const sender = msg.getSender();
                        const content = msg.getContent();
                        chat(sender, content);
                    }
                };

                // Event: Error
                client.onError = function(errorCode, errorMsg) {
                    dbg("‚ùå ERROR " + errorCode + ": " + errorMsg);
                    setStatus("üî¥ ERROR: " + errorCode, "#ff0000");
                    chat("ERROR", errorMsg);
                };

                // Event: Subscribed
                client.onSubscribed = function(channels, results) {
                    dbg("‚úÖ Subscribed to: " + channels.join(", "));
                };

                // Start heartbeat
                dbg("üíì Starting service loop (heartbeat)...");
                setInterval(function() {
                    if (client) {
                        client.service();
                    }
                }, 50);

                // Connect
                const username = "Web_" + Math.floor(Math.random() * 10000);
                dbg("üë§ Username: " + username);
                dbg("üåé Region: US");
                dbg("üîå Connecting to Photon servers...");
                setStatus("üü° CONNECTING TO PHOTON...", "#ffff00");
                
                client.connectToRegionMaster("us", username);

            } catch (err) {
                dbg("üí• CRASH during initialization!");
                dbg("‚ùå Error: " + err.message);
                dbg("üìö Stack: " + err.stack);
                setStatus("üî¥ CRASHED", "#ff0000");
                chat("ERROR", "Initialization failed: " + err.message);
            }
        }

        // ===== SEND MESSAGE =====
        function sendMsg() {
            const input = document.getElementById("msgInput");
            const msg = input.value.trim();

            if (!msg) {
                dbg("‚ö†Ô∏è Empty message");
                return;
            }

            if (!client || !isConnected) {
                dbg("‚ùå Cannot send - not connected");
                chat("ERROR", "Not connected to Photon!");
                return;
            }

            try {
                dbg("üì§ Sending: " + msg);
                client.publishMessage(CHANNEL, msg);
                chat("You", msg);
                input.value = "";
            } catch (err) {
                dbg("‚ùå Send failed: " + err.message);
                chat("ERROR", "Failed to send message");
            }
        }

        // Enter key
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById("msgInput");
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMsg();
            });
        });

        // Show ready message
        dbg("‚ú® Script loaded and ready");
    </script>
</body>
</html>
