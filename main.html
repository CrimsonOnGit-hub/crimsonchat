<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In-Game Global Chat</title>
    <style>
        body { background-color: #121212; color: #eee; font-family: sans-serif; display: flex; flex-direction: column; height: 95vh; margin: 0; padding: 10px; }
        #header { color: #ff4444; font-weight: bold; text-align: center; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        #chat-log { flex: 1; overflow-y: auto; background: #000; border: 1px solid #333; border-radius: 5px; padding: 15px; font-family: monospace; font-size: 14px; line-height: 1.5; }
        .controls { display: flex; gap: 10px; margin-top: 15px; }
        input { flex: 1; padding: 12px; border-radius: 4px; border: 1px solid #444; background: #222; color: white; outline: none; }
        input:focus { border-color: #ff4444; }
        button { padding: 10px 25px; background: #d32f2f; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { background: #b71c1c; }
        .sys { color: #888; font-style: italic; }
        .success { color: #4caf50; }
        .error { color: #f44336; }
    </style>
</head>
<body>

    <div id="header">CRIMSON PROTOCOLS: WEB BRIDGE</div>
    <div id="chat-log"><div class="sys">System: Initializing...</div></div>
    
    <div class="controls">
        <input type="text" id="msgInput" placeholder="Type a message..." disabled>
        <button id="sendBtn" onclick="sendMsg()" disabled>SEND</button>
    </div>

    <!-- 1. LOAD PHOTON SDK -->
    <script src="https://unpkg.com"></script>

    <script>
        // --- CONFIGURATION (2026 Ready) ---
        const APP_ID = "512c0979-f7b9-496c-b07b-5d5f753ae9c9";
        const VERSION = "1.0";
        const CHANNEL = "ingame"; // Updated as requested

        var chatClient;
        const logBox = document.getElementById("chat-log");
        const inputField = document.getElementById("msgInput");
        const sendBtn = document.getElementById("sendBtn");

        function addLog(html) {
            const div = document.createElement("div");
            div.innerHTML = html;
            logBox.appendChild(div);
            logBox.scrollTop = logBox.scrollHeight;
        }

        // --- START CONNECTION ---
        window.onload = function() {
            if (typeof Photon === 'undefined') {
                addLog("<span class='error'>Error: Photon SDK not loaded. Check internet.</span>");
                return;
            }

            // protocol 1 = Wss (Secure WebSockets)
            chatClient = new Photon.Chat.ChatClient(1, APP_ID, VERSION);

            // Handle State Changes
            chatClient.onStateChange = function(state) {
                // State 10 = ConnectedToFrontEnd
                if (state === 10) {
                    addLog("<span class='success'>System: Connected! Joining '" + CHANNEL + "'...</span>");
                    chatClient.subscribe([CHANNEL]);
                    inputField.disabled = false;
                    sendBtn.disabled = false;
                    inputField.focus();
                } else {
                    console.log("State:", state);
                }
            };

            // Handle Incoming Messages
            chatClient.onChatMessages = function(channel, senders, messages) {
                for (var i = 0; i < messages.length; i++) {
                    addLog("<b>" + senders[i] + ":</b> " + messages[i]);
                }
            };

            // Error Handling
            chatClient.onError = function(errorCode, errorMsg) {
                addLog("<span class='error'>Error (" + errorCode + "): " + errorMsg + "</span>");
            };

            // CRUCIAL: Heartbeat / Service Loop
            setInterval(function() {
                if (chatClient) {
                    // Check for both cases due to SDK version differences
                    if (chatClient.Service) chatClient.Service();
                    else if (chatClient.service) chatClient.service();
                }
            }, 50);

            // Authentication & Connect
            var userId = "WebAdmin_" + Math.floor(Math.random() * 1000);
            addLog("<span class='sys'>Connecting to US Region...</span>");
            
            // Connect specifically to US region
            chatClient.connectToRegionMaster("US", userId);
        };

        // --- SEND LOGIC ---
        function sendMsg() {
            var text = inputField.value;
            if (!text || text.trim() === "") return;

            if (chatClient && chatClient.publishMessage(CHANNEL, text)) {
                addLog("<b>Me (Web):</b> " + text);
                inputField.value = "";
            } else {
                addLog("<span class='error'>Failed to send. Reconnecting...</span>");
            }
        }

        // Enter Key Listener
        inputField.addEventListener("keydown", function(e) {
            if (e.keyCode === 13) sendMsg();
        });
    </script>
</body>
</html>
